<!doctype html><html><head><title>Logging in go-api-basic</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link rel=stylesheet href=/css/flag-icon.min.css><link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css><link rel=icon type=image/png href=/images/author/dan_hu9475e40123017607cf3e014e405fbc8c_9664_42x0_resize_q75_box.jpg><meta property="og:title" content="Logging in go-api-basic"><meta property="og:description" content="Logging in go-api-basic"><meta property="og:type" content="article"><meta property="og:url" content="https://gilcrest.github.io/posts/logging/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-07-13T07:30:00-04:00"><meta property="article:modified_time" content="2021-07-13T07:30:00-04:00"><meta name=description content="Logging in go-api-basic"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><link rel=stylesheet href=/css/style.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-WB0P084V1J"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-WB0P084V1J',{anonymize_ip:!1})}</script></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/><img src=/images/author/dan_hu9475e40123017607cf3e014e405fbc8c_9664_42x0_resize_q75_box.jpg alt=Logo>
Dan Gillis</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div><img src=/images/author/dan_hu9475e40123017607cf3e014e405fbc8c_9664_42x0_resize_q75_box.jpg class=d-none id=main-logo alt=Logo>
<img src=/images/author/dan_hu9475e40123017607cf3e014e405fbc8c_9664_42x0_resize_q75_box.jpg class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><a class=active href=/posts/logging/ title="Logging in go-api-basic">Logging in go-api-basic</a></li><li><a href=/posts/errors/ title="REST API Error Handling in Go">REST API Error Handling in Go</a></li><li><a href=/posts/gopherhole/ title="Emerging from my Gopher Hole">Emerging from my Gopher Hole</a></li><li><a href=/posts/conversion/ title="Jekyll to Hugo Conversion">Jekyll to Hugo Conversion</a></li><li><i class="fas fa-plus-circle"></i><a href=/posts/archive/>Archive</a><ul><li><a href=/posts/archive/http-logging-and-go-api-template-updates/ title="HTTP Logging and Go API Template Updates">HTTP Logging and Go API Template Updates</a></li><li><a href=/posts/archive/basic-redis-examples/ title="Basic Redis Examples with Go">Basic Redis Examples with Go</a></li><li><a href=/posts/archive/containerize-go-api/ title="Containerizing a Go API with Docker For Mac">Containerizing a Go API with Docker For Mac</a></li><li><a href=/posts/archive/http-json-error-responses/ title="HTTP JSON Error Responses in Go">HTTP JSON Error Responses in Go</a></li><li><a href=/posts/archive/king-crimson-red/ title="Drums - King Crimson Red Live @ Great Scott">Drums - King Crimson Red Live @ Great Scott</a></li><li><a href=/posts/archive/go-api-template/ title="Go API Template v0.0.2">Go API Template v0.0.2</a></li><li><a href=/posts/archive/go/ title=Go>Go</a></li><li><a href=/posts/archive/frankenstein/ title="Drums - Frankenstein Practice">Drums - Frankenstein Practice</a></li><li><a href=/posts/archive/osx-oracle-node-setup/ title="OS X Oracle + Node setup">OS X Oracle + Node setup</a></li><li><a href=/posts/archive/drums-raju-live/ title="Drums - Raju Live">Drums - Raju Live</a></li><li><a href=/posts/archive/apex-minimize/ title="Apex 5 - Minimize Left Sidebar">Apex 5 - Minimize Left Sidebar</a></li><li><a href=/posts/archive/raiser/ title=Raiser>Raiser</a></li><li><i class="fas fa-plus-circle"></i><a href=/posts/archive/node-oracle-glory/>Node Oracle Glory</a><ul><li><a href=/posts/archive/node-oracle-glory/volume-3/ title="Volume 3">Volume 3</a></li><li><a href=/posts/archive/node-oracle-glory/volume-2/ title="Volume 2">Volume 2</a></li><li><a href=/posts/archive/node-oracle-glory/volume-1/ title="Volume 1">Volume 1</a></li></ul></li><li><a href=/posts/archive/name-value-encryption/ title="Name:Value Encryption Utility using PL/SQL">Name:Value Encryption Utility using PL/SQL</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://gilcrest.github.io/posts/logging/hero.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/dan_hu9475e40123017607cf3e014e405fbc8c_9664_120x120_fit_q75_box.jpg alt="Author Image"><h5 class=author-name>Dan Gillis</h5><p>July 13, 2021</p></div><div class=title><h1>Logging in go-api-basic</h1></div><div class=post-content id=post-content><h2 id=thoughts-on-logging>Thoughts on Logging</h2><p>I&rsquo;ve gone through a few logging phases in my career. I logged <em>everything</em>. It was great, until the logs became meaningless because there were too many. I logged only errors, but in some cases that was not enough. Now I&rsquo;m somewhere in the middle. I do believe in logging all errors and detailed how I do that in <a href=https://dangillis.dev/posts/errors/#typical-error-response>my last post</a>. There are also times when it&rsquo;s helpful to have some debugging logs in place. As an example, if you&rsquo;ve ever tried to build a google doc using their APIs, then you may know that it can be helpful to have some tidbits of information about the document index position along your code/document path. In cases like this, I will leave debug logs in place in order to be able to pull the thread on them later if need be. Often times, I may deploy a change with some logs in place until I&rsquo;ve seen enough data in action in production and then back out the logs in the next change when I&rsquo;m satisfied. In general, I try to minimize the amount of logging in my code and only put logs in where it counts.</p><h2 id=logging-in-go-api-basic-with-zerolog>Logging in go-api-basic with zerolog</h2><p><a href=https://github.com/gilcrest/go-api-basic>go-api-basic</a> uses the <a href=https://github.com/rs/zerolog>zerolog</a> library from <a href=https://github.com/rs>Olivier Poitrey</a>. I&rsquo;m not gonna lie - initially, I chose this library because Olivier uses it at <a href="https://github.com/Netflix?language=go">Netflix</a> and that was enough for me. Over time though, I&rsquo;ve really come to love this logging library and Olivier is a great maintainer. I spent a lot of time a couple of years ago helping with the README and a number of other things in the library along the way. I&rsquo;ve learned a lot about Go and open source just from these interactions. If I use a library, I generally try to give back in some way to it, but often times through these interactions, I get back more in return, actually.</p><p>The mechanics for using <code>zerolog</code> are straightforward and are well documented in the library&rsquo;s <a href=https://github.com/rs/zerolog#readme>README</a>. <code>zerolog</code> takes an <code>io.Writer</code> as input to create a new logger; for simplicity in <code>go-api-basic</code>, I use <code>os.Stdout</code>.</p><h2 id=setting-logger-state-on-startup>Setting Logger State on Startup</h2><p>When starting <code>go-api-basic</code>, there are several flags which setup the logger:</p><table><thead><tr><th>Flag Name</th><th>Description</th><th>Environment Variable</th><th>Default</th></tr></thead><tbody><tr><td>log-level</td><td>zerolog logging level (debug, info, etc.)</td><td>LOG_LEVEL</td><td>debug</td></tr><tr><td>log-level-min</td><td>sets the minimum accepted logging level</td><td>LOG_LEVEL_MIN</td><td>debug</td></tr><tr><td>log-error-stack</td><td>If true, log full error stacktrace, else just log error</td><td>LOG_ERROR_STACK</td><td>false</td></tr></tbody></table><hr><blockquote><p><code>go-api-basic</code> uses the <a href=https://github.com/peterbourgon/ff>ff</a> library from <a href=https://peter.bourgon.org>Peter Bourgon</a>, which allows for using either flags or environment variables. Click <a href=https://github.com/gilcrest/go-api-basic#command-line-flags>here</a> if you want more info on this setup. Going forward, we&rsquo;ll assume you&rsquo;ve chosen flags.</p></blockquote><p>The <code>log-level</code> flag sets the Global logging level for your <code>zerolog.Logger</code>.</p><p><strong>zerolog</strong> allows for logging at the following levels (from highest to lowest):</p><ul><li>panic (<code>zerolog.PanicLevel</code>, 5)</li><li>fatal (<code>zerolog.FatalLevel</code>, 4)</li><li>error (<code>zerolog.ErrorLevel</code>, 3)</li><li>warn (<code>zerolog.WarnLevel</code>, 2)</li><li>info (<code>zerolog.InfoLevel</code>, 1)</li><li>debug (<code>zerolog.DebugLevel</code>, 0)</li><li>trace (<code>zerolog.TraceLevel</code>, -1)</li></ul><p>The <code>log-level-min</code> flag sets the minimum accepted logging level, which means, for example, if you set the minimum level to error, the only logs that will be sent to your chosen output will be those that are greater than or equal to error (<code>error</code>, <code>fatal</code> and <code>panic</code>).</p><p>The <code>log-error-stack</code> boolean flag tells whether to log stack traces for each error. If <code>true</code>, the <code>zerolog.ErrorStackMarshaler</code> will be set to <code>pkgerrors.MarshalStack</code> which means, for errors raised using the <a href=https://github.com/pkg/errors>github.com/pkg/errors</a> package, the error stack trace will be captured and printed along with the log. All errors raised in <code>go-api-basic</code> are raised using <code>github.com/pkg/errors</code>.</p><h2 id=reading-and-modifying-logger-state>Reading and Modifying Logger State</h2><p>You can retrieve and update the state of these flags using two web services I created in <code>go-api-basic</code> at the <code>{{base_url}}/api/v1/logger</code> endpoint.</p><p>To retrieve the current logger state use a <code>GET</code> request:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl --location --request GET <span style=color:#e6db74>&#39;http://127.0.0.1:8080/api/v1/logger&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--header <span style=color:#e6db74>&#39;Authorization: Bearer &lt;REPLACE WITH ACCESS TOKEN&gt;&#39;</span>
</code></pre></div><p>and the response will look something like:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;logger_minimum_level&#34;</span>: <span style=color:#e6db74>&#34;debug&#34;</span>,
    <span style=color:#f92672>&#34;global_log_level&#34;</span>: <span style=color:#e6db74>&#34;error&#34;</span>,
    <span style=color:#f92672>&#34;log_error_stack&#34;</span>: <span style=color:#66d9ef>false</span>
}
</code></pre></div><p>In order to update the logger state use a <code>PUT</code> request:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl --location --request PUT <span style=color:#e6db74>&#39;http://127.0.0.1:8080/api/v1/logger&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--header <span style=color:#e6db74>&#39;Content-Type: application/json&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--header <span style=color:#e6db74>&#39;Authorization: Bearer &lt;REPLACE WITH ACCESS TOKEN&gt;&#39;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--data-raw <span style=color:#e6db74>&#39;{
</span><span style=color:#e6db74>    &#34;global_log_level&#34;: &#34;debug&#34;,
</span><span style=color:#e6db74>    &#34;log_error_stack&#34;: &#34;true&#34;
</span><span style=color:#e6db74>}&#39;</span>
</code></pre></div><p>and the response will look something like:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
    <span style=color:#f92672>&#34;logger_minimum_level&#34;</span>: <span style=color:#e6db74>&#34;debug&#34;</span>,
    <span style=color:#f92672>&#34;global_log_level&#34;</span>: <span style=color:#e6db74>&#34;debug&#34;</span>,
    <span style=color:#f92672>&#34;log_error_stack&#34;</span>: <span style=color:#66d9ef>true</span>
}
</code></pre></div><p>The <code>PUT</code> response is the same as the <code>GET</code> response, but with updated values. In the examples above, I used a scenario where the logger state started with the global logging level (<code>global_log_level</code>) at error and error stack tracing (<code>log_error_stack</code>) set to false. The <code>PUT</code> request then updates the logger state, setting the global logging level to <code>debug</code> and the error stack tracing. You might do something like this if you are debugging an issue and need to see debug logs or error stacks to help with that.</p><blockquote class=twitter-tweet><p lang=en dir=ltr><a href="https://twitter.com/hashtag/golang?src=hash&ref_src=twsrc%5Etfw">#golang</a> modules you probably shouldn't use<a href=https://t.co/33ROwusCgx>https://t.co/33ROwusCgx</a> — basically superseded by 1.13+ stdlib package errors <a href=https://t.co/TC8K4IAw85>https://t.co/TC8K4IAw85</a>, <a href=https://t.co/XRNj1H0zTJ>https://t.co/XRNj1H0zTJ</a> — plain DI with interfaces/mocks is strictly superior almost always (exceptions know they're exceptions)</p>&mdash; ✕✕✕✕✕ (@peterbourgon) <a href="https://twitter.com/peterbourgon/status/1411167609983229954?ref_src=twsrc%5Etfw">July 3, 2021</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p><a href=https://peter.bourgon.org>Peter Bourgon</a> recently tweeted the above about <code>github.com/pkg/errors</code>. He&rsquo;s not wrong. In general the standard library is always the way to go. For years I only used the standard library for raising errors and would annotate each error with the function name in order to capture a pseudo stack trace exactly like Rob Pike does in <a href=https://commandcenter.blogspot.com/2017/12/error-handling-in-upspin.html>this post</a> (the <code>errs.Op</code> field). I believe in annotating and logging every error - not everyone does. It can cause noise in your logs, but in my experience, it&rsquo;s helpful. After years of trying to annotate every error though, I found I made too many mistakes. I kept forgetting to log the function name or I would misspell it, etc. I switched to use <code>github.com/pkg/errors</code> because of it&rsquo;s stack trace capability as well as the integration <code>zerolog</code> has with it. Stack trace for errors can certainly be overkill though, hence the ability to turn it on/off with a service for tactical usage can come in handy.</p><p><img src=log.gif alt="My log does not judge."></p><blockquote><p>No actual logs were harmed in this post.</p></blockquote></div><div class=btn-improve-page><a href=https://github.com/gilcrest/gilcrest.github.io/edit/source/content/posts/logging/index.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Improve this page</a></div><hr><div class="row next-prev-navigator"><div class="col-md-12 next-article"><a href=/posts/errors/ title="REST API Error Handling in Go" class="btn btn-outline-info"><div>Next <i class="fas fa-chevron-circle-right"></i></div><div class=next-prev-text>REST API Error Handling in Go</div></a></div></div><hr><div id=disqus_thread></div><script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement("script"),a.type="text/javascript",a.async=!0,b="dangillis",a.src="//"+b+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)})()</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#thoughts-on-logging>Thoughts on Logging</a></li><li><a href=#logging-in-go-api-basic-with-zerolog>Logging in go-api-basic with zerolog</a></li><li><a href=#setting-logger-state-on-startup>Setting Logger State on Startup</a></li><li><a href=#reading-and-modifying-logger-state>Reading and Modifying Logger State</a></li></ul></nav></div></div></section></div><footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=/#about>About</a></li><li class=nav-item><a class=smooth-scroll href=/#recent-posts>Recent Posts</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><span>Email:</span> <span>dan@dangillis.dev</span></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_2.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2021 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script><script type=text/javascript src=/js/popper.min.js></script><script type=text/javascript src=/js/bootstrap.min.js></script><script type=text/javascript src=/js/navbar.js></script><script type=text/javascript src=/js/plyr.js></script><script type=text/javascript src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script><script src=/js/single.js></script><script>hljs.initHighlightingOnLoad()</script></body></html>