<!doctype html><html>
<head>
<title>Containerizing a Go API with Docker For Mac</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="ie=edge">
<link rel=stylesheet href=/css/bootstrap.min.css>
<link rel=stylesheet href=/css/layouts/main.css>
<link rel=stylesheet href=/css/navigators/navbar.css>
<link rel=stylesheet href=/css/plyr.css>
<link rel=stylesheet href=/css/flag-icon.min.css>
<link rel=stylesheet href=/css/katex.min.css>
<link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600">
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css>
<link rel=icon type=image/png href=/images/author/dan_hu9475e40123017607cf3e014e405fbc8c_9664_42x0_resize_q75_box.jpg>
<meta property="og:title" content="Containerizing a Go API with Docker For Mac">
<meta property="og:description" content="Containerizing a Go API with Docker For Mac">
<meta property="og:type" content="article">
<meta property="og:url" content="https://gilcrest.github.io/posts/archive/containerize-go-api/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2018-04-06T07:10:00-04:00">
<meta property="article:modified_time" content="2018-04-06T07:10:00-04:00">
<meta name=description content="Containerizing a Go API with Docker For Mac">
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css>
<link rel=stylesheet href=/css/layouts/single.css>
<link rel=stylesheet href=/css/navigators/sidebar.css>
<link rel=stylesheet href=/css/style.css>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WB0P084V1J"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-WB0P084V1J',{anonymize_ip:!1})}</script>
</head>
<body data-spy=scroll data-target=#TableOfContents data-offset=80>
<div class="container-fluid bg-dimmed wrapper">
<nav class="navbar navbar-expand-xl top-navbar final-navbar shadow">
<div class=container>
<button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span>
</button>
<a class=navbar-brand href=/>
<img src=/images/author/dan_hu9475e40123017607cf3e014e405fbc8c_9664_42x0_resize_q75_box.jpg alt=Logo>
Dan Gillis</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse lang-selector" id=top-nav-items>
<ul class="navbar-nav ml-auto">
</ul>
</div>
</div>
<img src=/images/author/dan_hu9475e40123017607cf3e014e405fbc8c_9664_42x0_resize_q75_box.jpg class=d-none id=main-logo alt=Logo>
<img src=/images/author/dan_hu9475e40123017607cf3e014e405fbc8c_9664_42x0_resize_q75_box.jpg class=d-none id=inverted-logo alt="Inverted Logo">
</nav>
<section class=sidebar-section id=sidebar-section>
<div class=sidebar-holder>
<div class=sidebar id=sidebar>
<form class=mx-auto method=get action=/search>
<input type=text name=keyword placeholder=Search data-search id=search-box>
</form>
<div class=sidebar-tree>
<ul class=tree id=tree>
<li id=list-heading><a href=/posts data-filter=all>Posts</a></li>
<div class=subtree>
<li><a href=/posts/logging/ title="Logging in go-api-basic">Logging in go-api-basic</a></li>
<li><a href=/posts/errors/ title="REST API Error Handling in Go">REST API Error Handling in Go</a></li>
<li><a href=/posts/gopherhole/ title="Emerging from my Gopher Hole">Emerging from my Gopher Hole</a></li>
<li><a href=/posts/conversion/ title="Jekyll to Hugo Conversion">Jekyll to Hugo Conversion</a></li>
<li>
<i class="fas fa-minus-circle"></i><a class=active href=/posts/archive/>Archive</a>
<ul class=active>
<li><a href=/posts/archive/http-logging-and-go-api-template-updates/ title="HTTP Logging and Go API Template Updates">HTTP Logging and Go API Template Updates</a></li>
<li><a href=/posts/archive/basic-redis-examples/ title="Basic Redis Examples with Go">Basic Redis Examples with Go</a></li>
<li><a class=active href=/posts/archive/containerize-go-api/ title="Containerizing a Go API with Docker For Mac">Containerizing a Go API with Docker For Mac</a></li>
<li><a href=/posts/archive/http-json-error-responses/ title="HTTP JSON Error Responses in Go">HTTP JSON Error Responses in Go</a></li>
<li><a href=/posts/archive/king-crimson-red/ title="Drums - King Crimson Red Live @ Great Scott">Drums - King Crimson Red Live @ Great Scott</a></li>
<li><a href=/posts/archive/go-api-template/ title="Go API Template v0.0.2">Go API Template v0.0.2</a></li>
<li><a href=/posts/archive/go/ title=Go>Go</a></li>
<li><a href=/posts/archive/frankenstein/ title="Drums - Frankenstein Practice">Drums - Frankenstein Practice</a></li>
<li><a href=/posts/archive/osx-oracle-node-setup/ title="OS X Oracle + Node setup">OS X Oracle + Node setup</a></li>
<li><a href=/posts/archive/drums-raju-live/ title="Drums - Raju Live">Drums - Raju Live</a></li>
<li><a href=/posts/archive/apex-minimize/ title="Apex 5 - Minimize Left Sidebar">Apex 5 - Minimize Left Sidebar</a></li>
<li><a href=/posts/archive/raiser/ title=Raiser>Raiser</a></li>
<li>
<i class="fas fa-plus-circle"></i><a href=/posts/archive/node-oracle-glory/>Node Oracle Glory</a>
<ul>
<li><a href=/posts/archive/node-oracle-glory/volume-3/ title="Volume 3">Volume 3</a></li>
<li><a href=/posts/archive/node-oracle-glory/volume-2/ title="Volume 2">Volume 2</a></li>
<li><a href=/posts/archive/node-oracle-glory/volume-1/ title="Volume 1">Volume 1</a></li>
</ul>
</li>
<li><a href=/posts/archive/name-value-encryption/ title="Name:Value Encryption Utility using PL/SQL">Name:Value Encryption Utility using PL/SQL</a></li>
</ul>
</li>
</div>
</ul>
</div>
</div>
</div>
</section>
<section class=content-section id=content-section>
<div class=content>
<div class="container p-0 read-area">
<div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://gilcrest.github.io/images/default-hero.jpg)>
</div>
<div class=page-content>
<div class="author-profile ml-auto align-self-lg-center">
<img class=rounded-circle src=/images/author/dan_hu9475e40123017607cf3e014e405fbc8c_9664_120x120_fit_q75_box.jpg alt="Author Image">
<h5 class=author-name>Dan Gillis</h5>
<p>Friday, April 6, 2018</p>
</div>
<div class=title>
<h1>Containerizing a Go API with Docker For Mac</h1>
</div>
<div class=post-content id=post-content>
<p>I’m working through creating a <a href=https://github.com/gilcrest/go-API-template>RESTful API template</a>. As part of it, I want to be able to “Containerize” my app using docker and deploy it to “the cloud”. Baby steps for me though — I want to get everything working locally first. This post is about “containerizing” my API using Docker and getting it to work locally on my Mac. Right now, from a networking perspective, my app is pretty simple — it needs connectivity on two ports: 1 port for database traffic, 1 port for http traffic.</p>
<h2 id=part-1--simple-build-against-local-postgresql-exposing-ports-5432-for-postgresql-and-8080-for-http-traffic-from-my-local-host-to-my-container>Part 1 — Simple build against local PostgreSQL, exposing ports 5432 for PostgreSQL and 8080 for http traffic from my local host to my container</h2>
<p>First off, you must have Docker for Mac installed. Once installed, you’ll need to familiarize yourself with the various docker commands and idioms. I highly recommend <a href="https://smile.amazon.com/Docker-Deep-Dive-Nigel-Poulton-ebook/dp/B01LXWQUFF/ref=mt_kindle?_encoding=UTF8&me=">Docker Deep Dive</a>. I read a lot of different blogs and how-tos on Docker and wasn’t able to really put it all together until I read this book.</p>
<p>For my database, I have PostgreSQL running locally on my Mac using <a href=https://postgresapp.com/>Postgres.app</a> — you can use whatever you like, but I find this product incredibly simple to use. I do not change any of the default settings, which means Postgres listens on port 5432.</p>
<p>For database configuration (dbname, host, port, user, password), I’m storing everything as <a href=https://www.digitalocean.com/community/tutorials/how-to-read-and-set-environmental-and-shell-variables-on-a-linux-vps>environment variables</a> and accessing them within my Go program via os.Getenv, e.g.:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>dbName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;PG_DBNAME_TEST&#34;</span>)
<span style=color:#a6e22e>dbUser</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;PG_USERNAME_TEST&#34;</span>)
<span style=color:#a6e22e>dbPassword</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;PG_PASSWORD_TEST&#34;</span>)
<span style=color:#a6e22e>dbHost</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;PG_HOST_TEST&#34;</span>)
<span style=color:#a6e22e>dbPort</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;PG_PORT_TEST&#34;</span>))
<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Error</span>().<span style=color:#a6e22e>Err</span>(<span style=color:#a6e22e>err</span>).<span style=color:#a6e22e>Msg</span>(<span style=color:#e6db74>&#34;Unable to complete string to int conversion for dbPort&#34;</span>)
    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
}
</code></pre></div><p>My Dockerfile for this part is quite simple and similar to the one on the <a href=https://blog.golang.org/docker>official golang blog</a>. I use dep (will eventually switch to vgo) to “vendor my dependencies” so as part of my build I don’t need to “go get” any external dependencies as they’re copied over as part of the ADD command when I copy the entire workspace over from my local host to the container.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=color:#75715e># Start from a Debian image with the latest version of Go installed</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># and a workspace (GOPATH) configured at /go.</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> golang:latest</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Create WORKDIR (working directory) for app</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /go/src/github.com/gilcrest/go-API-template</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Copy the local package files to the container&#39;s workspace</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># (in the above WORKDIR)</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> . .<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Switch WORKDIR to directory where server main.go lives</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /go/src/github.com/gilcrest/go-API-template/cmd/server</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Build the go-API-template userServer command inside the container</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># at the most recent WORKDIR</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> go build -o userServer<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Run the userServer command by default when the container starts.</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># runs command at most recent WORKDIR</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> ./userServer<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Document that the container uses port 8080</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8080</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Document that the container uses port 5432</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 5432</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>Let’s break down what’s happening in this file:</p>
<p><strong>FROM golang:latest</strong> — This command tells Docker to pull the golang image with the latest tag from the official Docker repository as the first layer.</p>
<p><strong>WORKDIR /go/src/github.com/gilcrest/go-API-template</strong> — This command sets the working directory to the path given. This directory doesn’t already exist, so, it will be created.</p>
<p><strong>ADD . .</strong> — This command copies all the files, directories and subdirectories from the current directory where the Dockerfile is located and moves them to the WORKDIR defined above</p>
<p><strong>WORKDIR /go/src/github.com/gilcrest/go-API-template/cmd/server</strong> — This command sets the working directory to the path given. This directory exists already.</p>
<p><strong>RUN go build -o userServer</strong> — This command builds the application binary from main.go within the work directory and creates the binary with the given name userServer</p>
<p><strong>ENTRYPOINT ./userServer</strong> — This command sets the container to run as an executable and runs the userServer binary created earlier</p>
<p><strong>EXPOSE 8080 and EXPOSE 5432</strong> — These commands are really documentation only. They document that this image needs these ports exposed to function properly.</p>
<p>To build the image from my Dockerfile, I run the following command from my app’s root directory (which is where I also store my Dockerfile):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># Build image with gilcrest as repository name, go-api-template </span>
<span style=color:#75715e># as build name and latest as build tag from the current directory</span>

$ docker image build -t gilcrest/go-api-template:latest .
</code></pre></div><p>After successfully building my new image, I use the below command to run it:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># Run container using previously built image (gilcrest/go-api-template)</span>
<span style=color:#75715e># -d Run in the background (detached)</span>
<span style=color:#75715e># -p publish port 5432 on the host to port 5432 on the container for postgres</span>
<span style=color:#75715e># -p publish port 8080 on the host to port 8080 on the container for http access</span>
<span style=color:#75715e># --env-file load environment variables using the env file</span>
<span style=color:#75715e># --name name the container user-server</span>

$ docker container run -d -p 5432:5432 -p 8080:8080 --env-file ./test.env --name user-server gilcrest/go-api-template
</code></pre></div><p>To quickly go through all the options as part of the run command above:</p>
<p><strong>-d</strong>: Runs the container in the background as a “detached” session or daemon</p>
<p><strong>-p</strong>: publishes ports from the host to ports on the container (host on left of colon, container on right of colon)</p>
<p><strong>-—env-file</strong>: where to pull “environment file” for setting environment variables at run time</p>
<p><strong>-—name</strong>: gives the container a unique identifier</p>
<hr>
<p>A couple of gotchas I’d like to point out that I ended up spending hours researching that may be helpful for some.</p>
<p>To connect to PostgreSQL running on your Mac (the docker “host”) from within a running container, you have to know the host’s IP address. Seeing as when running a container as part of Docker for Mac, you’re actually running within a lightweight VM, determining your actual host IP address can be a tricky proposition as the IP is not static. Luckily, more recent Docker for Mac versions allow you to use special DNS name host.docker.internal to determine the host IP address. See <a href=https://docs.docker.com/docker-for-mac/networking/#use-cases-and-workarounds>I WANT TO CONNECT FROM A CONTAINER TO A SERVICE ON THE HOST</a> on the docker site for the full details.</p>
<p>Another challenge was actually connecting to my API endpoint running in my container from my local machine. Prior to using Docker, I had been specifying a particular IP address for my localhost when setting up http.ListenAndServe, e.g. <strong>http.ListenAndServe(“127.0.0.1:8080”, nil)</strong>, but seeing as when you run your container using Docker for Mac, you’re running within a lightweight VM, it will have a different IP than the standard loopback localhost IP (127.0.0.1). I tried docker inspect but had a pretty hard time figuring out exactly what IP I would need to try and hit to make this work. I ended up removing the loopback localhost IP from the addr function parameter for http.ListenAndServe and only have the port as part of the string, as in below (“:8080”).</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// ListenAndServe on port 8080, not specifying a particular IP address for this particular implementation
</span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:8080&#34;</span>, <span style=color:#66d9ef>nil</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
}
</code></pre></div><p>Once you’ve removed this IP, you can then use “localhost” and port 8080 to connect to your APIs running within the container. Requests will be properly forwarded (e.g. a POST to<a href=http://localhost:8080/api/appUser>http://localhost:8080/api/appUser</a> now works and hits my container API!) See <a href=https://docs.docker.com/docker-for-mac/networking/#use-cases-and-workarounds>I WANT TO CONNECT TO A CONTAINER FROM THE MAC</a> on the Docker site for full details.</p>
<p>One thing to highlight from the former run command is the environment file that I use to load the environment key:value pairs from my local shell to the container’s shell environment.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ docker container run -d -p 5432:5432 -p 8080:8080 --env-file ./test.env --name user-server gilcrest/go-api-template
</code></pre></div><p>This file, which simply looks like:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>PG_DBNAME_TEST
PG_USERNAME_TEST
PG_PASSWORD_TEST
PG_HOST_TEST<span style=color:#f92672>=</span>host.docker.internal
PG_PORT_TEST
</code></pre></div><p>— tells Docker to pull in the above environment variables from the local shell and push them into the containers shell. For most of the variables, I am only providing the key and not the value. Docker will pull in the value from the shell environment that is running the command. For the PG_HOST_TEST variable I am providing the value (host.docker.internal) as I want to override the shell environment value on my Mac (localhost). This allows me to run my app either inside a container or just run it locally without a container as you would any non-containerized app, and it works in both cases. If I am running the app “normally” (non-containerized), the environment will have <em><strong>localhost</strong></em> as PG_HOST_TEST, if I’m running inside the container, I need <em><strong>host.docker.internal</strong></em> as the host name for the db.</p>
<p>Storing my configuration in the environment like this meets the “Twelve Factor App” guidelines, which I think are generally good. I make sure I have .env files in my .gitignore file to ensure that these config values don’t get checked in as part of my app (see below for .gitignore example).</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># Docker env files</span>
*.env
</code></pre></div><hr>
<p>Now that we’ve got the basics working, the image that is created is really pretty big — for my app it’s 882mb! If you’re building for the first time, then because of this size, the build process is also pretty slow…</p>
<p>As Gophers, naturally, we like our builds fast. In order to run smaller, faster, more secure/efficient images, Docker allows for <a href=https://docs.docker.com/develop/develop-images/multistage-build/>multi-stage builds</a>. As far as I can tell, this is pretty commonplace for running production containers and is considered a best practice.</p>
<h2 id=part-2--dockerizing-your-app-using-multi-stage-builds>Part 2 — Dockerizing your app using Multi-Stage Builds</h2>
<p>Docker allows for “multi-stage builds”, meaning you can pull down multiple images and copy artifacts from one stage to another — you can read all about it <a href=https://docs.docker.com/develop/develop-images/multistage-build/>here</a>. After trolling Slack and other blogs for information, the most common way I could find was to deploy apps using the Docker <a href=https://hub.docker.com/_/alpine/>Alpine Linux image</a>. This is a tiny image — 5mb!!! This makes building a lot faster and images way smaller. There is also an official golang Docker version using Alpine — <a href=https://hub.docker.com/_/golang/>golang:alpine</a>. This image isn’t as bare bones as the base Alpine Linux image as it has what’s needed to run Go.</p>
<p>I found several different methods of running containers using Alpine, many of which started with a “normal” Go base image, but that also requires you to compile the go binary in a special way as the Alpine Linux image is based on musl libc and busybox. My understanding is that because of this, you need to run a command similar to <code>RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o app .</code> to build your app. I don’t really know exactly what this command is doing, so I looked elsewhere.</p>
<p>An alternative is to use the golang:alpine image as your base image in your first “builder” stage and build as you normally would within it (e.g., go build -o app). As this image is already built within alpine, there seems to be no need to do the more complicated build command I mentioned above. You can then copy your app binary built within the first stage into your second stage which uses the alpine base image and it will run! My Dockerfile example is below:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=color:#75715e>####################################################################</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Builder Stage                                                    #</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>####################################################################</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Use the official Golang image to create a build artifact.</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># This is based on Debian and sets the GOPATH to /go.</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># https://hub.docker.com/_/golang</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> golang:alpine AS builder</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Create WORKDIR using project&#39;s root directory</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /go/src/github.com/gilcrest/go-API-template</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Copy the local package files to the container&#39;s workspace</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># in the above created WORKDIR</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> . .<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Build the go-API-template command inside the container</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd cmd/server <span style=color:#f92672>&amp;&amp;</span> go build -o userServer<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>####################################################################</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Final Stage                                                      #</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e>####################################################################</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Use the official Alpine image for a lean production container.</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># https://hub.docker.com/_/alpine</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># https://docs.docker.com/develop/develop-images/multistage-build/#use-multi-stage-builds</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine:3</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Create WORKDIR</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /src/github.com/gilcrest/go-API-template/input</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Copy json file needed for feature flags to directory expected by app</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># File is copied from the Builder stage image</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /go/src/github.com/gilcrest/go-API-template/input/httpLogOpt.json .<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Create WORKDIR</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Copy app binary from the Builder stage image</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /go/src/github.com/gilcrest/go-API-template/cmd/server/userServer .<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Run the userServer command by default when the container starts.</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> ./userServer<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Document that the service uses port 8080</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8080</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Document that the service uses port 5432</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 5432</span><span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>I went through most of the commands before, so I’ll just highlight a few things:</p>
<p><strong>FROM</strong> — There are two FROM commands — this is the essence of multi-stage builds. You can have as many FROM commands (stages) as you want… NOTE!! I have given the first stage a name using AS (FROM golang:alpine AS builder). This is important for later…</p>
<p><strong>RUN cd cmd/server && go build -o userServer</strong> — This command is two commands in one (the && allows for this). I first change the directory to cmd/server (remember, my working directory is the WORKDIR so I can work relative to that after the WORKDIR command). I then run the go build command sending it’s output binary to use userServer as it’s name.</p>
<p><strong>COPY</strong> — from=builder /go/src/github.com/gilcrest/go-API-template/cmd/server/userServer . — The COPY command is used to copy files or directories from a source to a destination within the container. In this case, I’m copying from the builder stage I had name earlier to the WORKDIR I’m working in — cool! I use the COPY command to copy a json file my app needs as well as my app binary.</p>
<p>All the other instructions are pretty straightforward and work the same as I had mentioned in Part 1, including the docker build and docker run commands. The only gotcha I’ve found so far is that if you for some reason want to run your container in interactive mode using <code>-it</code> (instead of <code>-d</code>) and have it run using <code>/bin/bash</code> as you normally would, that won’t work on an alpine container as it’s not there! You have to use <code>/bin/sh</code> instead.</p>
<p>That’s it for today — my next post will be about getting this container hoisted up to “the cloud” somehow… Onwards and upwards!</p>
</div>
<div class="row pl-3 pr-3">
<div class="col-md-6 share-buttons">
</div>
<div class="col-md-6 btn-improve-page">
<a href=https://github.com/gilcrest/gilcrest.github.io/edit/source/content/posts/archive/containerize-go-api/index.md title="Improve this page" target=_blank rel=noopener>
<i class="fas fa-code-branch"></i>
Improve this page
</a>
</div>
</div>
<hr>
<div class="row next-prev-navigator">
<div class="col-md-6 previous-article">
<a href=/posts/archive/basic-redis-examples/ title="Basic Redis Examples with Go" class="btn btn-outline-info">
<div><i class="fas fa-chevron-circle-left"></i> Prev</div>
<div class=next-prev-text>Basic Redis Examples with Go</div>
</a>
</div>
<div class="col-md-6 next-article">
<a href=/posts/archive/http-json-error-responses/ title="HTTP JSON Error Responses in Go" class="btn btn-outline-info">
<div>Next <i class="fas fa-chevron-circle-right"></i></div>
<div class=next-prev-text>HTTP JSON Error Responses in Go</div>
</a>
</div>
</div>
<hr>
<div id=disqus_thread></div>
<script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement("script"),a.type="text/javascript",a.async=!0,b="dangillis",a.src="//"+b+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
</div>
</div>
<a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a>
</section>
<section class=toc-section id=toc-section>
<div class=toc-holder>
<h5 class="text-center pl-3">Table of Contents</h5>
<hr>
<div class=toc>
<nav id=TableOfContents>
<ul>
<li><a href=#part-1--simple-build-against-local-postgresql-exposing-ports-5432-for-postgresql-and-8080-for-http-traffic-from-my-local-host-to-my-container>Part 1 — Simple build against local PostgreSQL, exposing ports 5432 for PostgreSQL and 8080 for http traffic from my local host to my container</a></li>
<li><a href=#part-2--dockerizing-your-app-using-multi-stage-builds>Part 2 — Dockerizing your app using Multi-Stage Builds</a></li>
</ul>
</nav>
</div>
</div>
</section>
</div>
<footer class="container-fluid text-center align-content-center footer pb-2">
<div class="container pt-5">
<div class="row text-left">
<div class="col-md-4 col-sm-12">
<h5>Navigation</h5>
<ul>
<li class=nav-item>
<a class=smooth-scroll href=https://gilcrest.github.io#about>About</a>
</li>
<li class=nav-item>
<a class=smooth-scroll href=https://gilcrest.github.io#recent-posts>Recent Posts</a>
</li>
</ul>
</div>
<div class="col-md-4 col-sm-12">
<h5>Contact me:</h5>
<ul>
<li><a href=mailto:dan@dangillis.dev target=_blank rel=noopener>
<span><i class="fas fa-envelope"></i></span> <span>dan@dangillis.dev</span>
</a></li>
</ul>
</div>
</div>
</div>
<hr>
<div class=container>
<div class="row text-left">
<div class=col-md-4>
<a id=theme href=https://github.com/hossainemruz/toha target=_blank rel=noopener>
<img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha
</a>
</div>
<div class="col-md-4 text-center">© 2021 Copyright.</div>
<div class="col-md-4 text-right">
<a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18>
</a>
</div>
</div>
</div>
</footer>
<script type=text/javascript src=/js/jquery-3.4.1.min.js></script>
<script type=text/javascript src=/js/popper.min.js></script>
<script type=text/javascript src=/js/bootstrap.min.js></script>
<script type=text/javascript src=/js/navbar.js></script>
<script type=text/javascript src=/js/plyr.js></script>
<script type=text/javascript src=/js/main.js></script>
<script type=text/javascript defer src=/js/katex.min.js></script>
<script type=text/javascript defer src=/js/auto-render.min.js onload=renderMathInElement(document.body)></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script>
<script src=/js/single.js></script>
<script>hljs.initHighlightingOnLoad()</script>
</body>
</html>